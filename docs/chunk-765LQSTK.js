import{a as ue,b as N,c as Ce}from"./chunk-YB2FRYXR.js";import{a as K,b as Te,c as Q,d as X}from"./chunk-JJWUV2CK.js";import{a as te,b as u,c as ne,d as oe,f as ie,g as ae,h as re,i as ce,j as le,k as se,l as me,m as pe,n as de,o as ge,p as _e,q as fe}from"./chunk-JISDSRV2.js";import{a as Y,b as L,c as D}from"./chunk-PBSUUAEE.js";import{$a as M,Ba as A,Ea as W,Ja as P,Mb as w,Nb as Z,Ob as J,P as q,Qa as S,Ta as k,Tb as I,Ua as $,Ub as ee,V as T,Va as z,Wa as H,Xa as r,Ya as i,Za as v,ab as y,ba as C,bb as _,ca as b,d as xe,e as f,gb as l,hb as O,ib as R,jb as B,ob as U,qb as V,rb as F,sb as x,va as d}from"./chunk-KGC6DHRS.js";var he=xe(Te());var E=class c{constructor(){}_indexeddbService=T(ee);_highchartService=T(Q);_genericService=T(I);_fb=T(pe);_categoryType=1;loadCategories(){return f(this,null,function*(){var n=new D;try{yield this._indexeddbService.getAllItems("categories","name","desc").then(e=>{n.data=e.items.filter(t=>t.type===this._categoryType),n.confirmation=!0,n.message="Categor\xEDas cargadas correctamente"},e=>{console.error(e),n.message=e.message,n.exception=e.toString()})}catch(e){console.error(e),n.message=e.message,n.exception=e.toString()}return n})}loadTable(n,e,t,o,s){return f(this,null,function*(){var p=new D;try{yield this._indexeddbService.getAllItems("transactions","created","desc").then(a=>{if(a.total>0){let h=n.search.trim().toLowerCase();e=a.items.filter(g=>g.category.type===this._categoryType&&(g.name.toLowerCase().includes(h)||g.description.toLowerCase().includes(h)||g.category.name.toLowerCase().includes(h))).map(g=>({transactionId:g.transactionId,name:g.name,amount:g.amount,amountString:this._genericService.convertToCurrencyFormat(g.amount).data,date:g.date,description:g.description,categoryId:g.categoryId,categoryName:g.category.name,categoryType:g.category.type,created:this._genericService.addMinutesToDate(g.created,o.minutesOfDifferenceTimeZone)})),n.total=e.length}let m=this.getChartOptions(e,t,o);m.confirmation?e.length>1&&s!==null?this._highchartService.updateChart(s,m.data):s=this._highchartService.buildChart("container",m.data):(p.message=m.message,p.exception=m.exception),p.data={partialTableOptions:n,transactions:e,categories:t,chart:s},p.confirmation=!0,p.message="Tabla cargada correctamente"},a=>{console.error(a),p.message=a.message,p.exception=a.toString()})}catch(a){console.error(a),p.message=a.message,p.exception=a.toString()}return p})}modalOpen(n,e=null){var t=new D;try{if(e!==null)t.data=this._fb.group({opc:["Edit"],opcLabel:["Editar"],transactionId:[e.transactionId,[u.required]],name:[e.name,[u.required,u.minLength(3),u.maxLength(20)]],amount:[e.amount.toString(),[u.required,N(2)]],date:[e.date,[u.required]],categoryId:[e.categoryId,[u.required]],description:[e.description]});else{let o=this._genericService.addMinutesToDate(this._genericService.getDateTimeNowUtc(),-300);t.data=this._fb.group({opc:["Create"],opcLabel:["Crear"],name:["",[u.required,u.minLength(3),u.maxLength(20)]],amount:["0",[u.required,N(2)]],date:[o,[u.required]],categoryId:[n[0].categoryId,[u.required]],description:[""]})}t.confirmation=!0,t.message="Modal abierto correctamente"}catch(o){console.error(o),t.message=o.message,t.exception=o.toString()}return t}createOrUpdate(n,e){return f(this,null,function*(){var t=new L;try{let o=n.value,s=this._genericService.parseNumber(o.amount.replace(".",""));if(!s.confirmation)return t.message=s.message,t.exception=s.exception,t;let p=e.find(a=>a.categoryId===o.categoryId&&a.type===this._categoryType);if(p===void 0)return t.message="No se encontr\xF3 la categor\xEDa",t;if(o.opc==="Edit")yield this._indexeddbService.getItem("transactions",o.transactionId).then(a=>f(this,null,function*(){a.name=o.name,a.amount=s.data,a.date=new Date(o.date),a.description=o.description,a.categoryId=o.categoryId,a.category=p,yield this._indexeddbService.updateItem("transactions",a.transactionId,a).then(m=>{t.confirmation=!0,t.message="Transacci\xF3n actualizada correctamente"},m=>{console.error(m),t.message=m.message,t.exception=m.toString()})}),a=>{console.error(a),t.message=a.message,t.exception=a.toString()});else{let a={transactionId:this._genericService.generateGuid(),name:o.name,amount:s.data,date:new Date(o.date),description:o.description,categoryId:o.categoryId,category:p,created:this._genericService.getDateTimeNowUtc()};yield this._indexeddbService.addItem("transactions",a).then(m=>{t.confirmation=!0,t.message="Transacci\xF3n creada correctamente"},m=>{console.error(m),t.message=m.message,t.exception=m.toString()})}}catch(o){console.error(o),t.message=o.message,t.exception=o.toString()}return t})}delete(n){return f(this,null,function*(){var e=new L;try{yield this._indexeddbService.deleteItem("transactions",n).then(t=>{e.confirmation=!0,e.message="Transacci\xF3n eliminada correctamente"},t=>{console.error(t),e.message=t.message,e.exception=t.toString()})}catch(t){console.error(t),e.message=t.message,e.exception=t.toString()}return e})}getChartOptions(n,e,t){var o=new D;try{let s=[],p=n.reduce((a,m)=>a+m.amount,0);for(let a=0;a<e.length;a++){let m=e[a],h=n.reduce((Oe,G)=>Oe+(G.categoryId===m.categoryId?G.amount:0),0),g=this._genericService.convertToCurrencyFormat(h).data,j=p>0?h*100/p:0,ye=this._genericService.parseNumber(j.toFixed(2)).data;s.push({id:m.categoryId,name:`${m.name} (${t.currency} ${g})`,y:ye,selected:!1,sliced:!1})}if(s.length>0){let a=s.reduce((m,h)=>m.y>h.y?m:h);a.name=`<b style="color: var(--color-green); font-size: 0.9rem;">${a.name}</b>`}o.data={title:{text:"Distribuci\xF3n de ingresos"},subtitle:{text:n.length>0?"":"Sin datos"},tooltip:{valueSuffix:"%"},series:n.length>0?[{type:"pie",name:"Porcentaje",showInLegend:!0,data:s}]:[]},o.confirmation=!0,o.message="Opciones del gr\xE1fico cargadas correctamente"}catch(s){console.error(s),o.message=s.message,o.exception=s.toString()}return o}static \u0275fac=function(e){return new(e||c)};static \u0275prov=q({token:c,factory:c.\u0275fac,providedIn:"root"})};function Se(c,n){if(c&1){let e=M();r(0,"div",8)(1,"h2"),l(2,"Historial"),i(),r(3,"button",9),y("click",function(){C(e);let o=_();return b(o.onOpenModal())}),l(4,"Agregar ingreso"),i(),r(5,"input",10),y("input",function(o){C(e);let s=_();return b(s.search(o))}),i()()}}function Me(c,n){c&1&&(r(0,"tr")(1,"th"),l(2,"Categor\xEDa"),i(),r(3,"th"),l(4,"Nombre"),i(),r(5,"th"),l(6,"Monto"),i(),r(7,"th"),l(8,"Fecha"),i(),r(9,"th"),l(10,"Descripci\xF3n"),i(),r(11,"th"),l(12,"Creaci\xF3n"),i(),r(13,"th"),l(14,"OPC"),i()())}function Pe(c,n){if(c&1){let e=M();r(0,"tr")(1,"td"),l(2),i(),r(3,"td"),l(4),i(),r(5,"td"),l(6),i(),r(7,"td"),l(8),V(9,"date"),i(),r(10,"td"),l(11),i(),r(12,"td"),l(13),V(14,"date"),i(),r(15,"td")(16,"div",11)(17,"button",12),y("click",function(){let o=C(e).$implicit,s=_();return b(s.onOpenModal(o))}),v(18,"i",13),i(),r(19,"button",14),y("click",function(){let o=C(e).$implicit,s=_();return b(s.onModalOpenDelete(o))}),v(20,"i",15),i()()()()}if(c&2){let e=n.$implicit,t=_();d(2),O(e.categoryName),d(2),O(e.name),d(2),B(" ",t._localStorage.currency," ",e.amountString," "),d(2),O(F(9,7,e.date,"dd/MM/yyyy hh:mm a")),d(3),O(e.description),d(2),O(F(14,10,e.created,"dd/MM/yyyy hh:mm a"))}}function Ie(c,n){if(c&1&&(r(0,"h2"),l(1),i()),c&2){let e,t=_(2);d(),R("",(e=t._form.get("opcLabel"))==null?null:e.value," ingreso")}}function De(c,n){if(c&1&&(r(0,"option",28),l(1),i()),c&2){let e=n.$implicit;S("value",e.categoryId),d(),O(e.name)}}function Ee(c,n){if(c&1&&(r(0,"div",18)(1,"div",19)(2,"label",20),l(3,"Nombre"),i(),v(4,"input",21),i(),r(5,"div",19)(6,"label",22),l(7,"Cantidad"),i(),v(8,"partial-inputnumber",23),i(),r(9,"div",19)(10,"label",24),l(11,"Fecha"),i(),v(12,"partial-inputdatetime",25),i(),r(13,"div",19)(14,"label",26),l(15,"Categor\xEDa"),i(),r(16,"select",27),z(17,De,2,2,"option",28,$),i()(),r(19,"div",19)(20,"label",29),l(21,"Descripci\xF3n"),i(),v(22,"textarea",30),i()()),c&2){let e=_(2);d(8),S("_form",e._form),d(4),S("_form",e._form),d(5),H(e._categories)}}function we(c,n){if(c&1&&(r(0,"div",31)(1,"button",32),l(2),i()()),c&2){let e,t=_(2);d(),S("disabled",t._form.invalid),d(),O((e=t._form.get("opcLabel"))==null?null:e.value)}}function ke(c,n){if(c&1){let e=M();r(0,"form",16),y("ngSubmit",function(){C(e);let o=_();return b(o.onSubmitForm(o._form))}),r(1,"partial-modal",17),y("eventCloseModal",function(){C(e);let o=_();return b(o.onCloseModal())}),P(2,Ie,2,1,"ng-template",null,1,x)(4,Ee,23,2,"ng-template",null,2,x)(6,we,3,2,"ng-template",null,3,x),i()()}if(c&2){let e=_();S("formGroup",e._form)}}function Re(c,n){c&1&&(r(0,"h2"),l(1,"Eliminar ingreso"),i())}function Ve(c,n){if(c&1&&(r(0,"h4"),l(1,"\xBFEst\xE1 seguro de que desea eliminar el ingreso "),r(2,"b"),l(3),i(),l(4,"?"),i()),c&2){let e=_(2);d(3),O(e._selectedTransaction.name)}}function Fe(c,n){if(c&1){let e=M();r(0,"partial-modalconfirmation",33),y("eventOnSuccess",function(){C(e);let o=_();return b(o.onDelete(o._selectedTransaction))})("eventOnCancel",function(){C(e);let o=_();return o._modals.deleteTransaction=!1,b(o._selectedTransaction=null)}),P(1,Re,2,0,"ng-template",null,1,x)(3,Ve,5,1,"ng-template",null,2,x),i()}}he.setOptions(X);var be=class c{constructor(){}_genericService=T(I);_incomesService=T(E);_form=null;_transactions=[];_selectedTransaction=null;_categories=[];_chart=null;_modals={transaction:!1,deleteTransaction:!1};_partialTableOptions={search:"",skip:0,take:5,total:0};_localStorage={currency:this._genericService.getLocalStorage("currency")||"$",language:this._genericService.getLocalStorage("language")||"es",minutesOfDifferenceTimeZone:-300};_totalAmountSignal=A("-");ngOnInit(){this.loadCategories()}ngAfterViewInit(){}ngOnDestroy(){}loadCategories(){return f(this,null,function*(){let n=yield this._incomesService.loadCategories();n.confirmation&&(this._categories=n.data,yield this.loadTable())})}loadTable(){return f(this,null,function*(){let n=yield this._incomesService.loadTable(this._partialTableOptions,this._transactions,this._categories,this._localStorage,this._chart);n.confirmation&&(this._partialTableOptions=n.data.partialTableOptions,this._transactions=n.data.transactions,this._categories=n.data.categories,this._chart=n.data.chart,this.loadTotalAmount())})}onOpenModal(n=null){var e=this._incomesService.modalOpen(this._categories,n);if(!e.confirmation){alert(e.message);return}this._form=e.data,this._selectedTransaction=n,this._modals.transaction=!0}onCloseModal(){this._modals.transaction=!1,this._form=null}onSubmitForm(n){return f(this,null,function*(){var e=yield this._incomesService.createOrUpdate(n,this._categories);if(!e.confirmation){alert(e.message);return}this._modals.transaction=!1,this.loadTable()})}onModalOpenDelete(n){this._selectedTransaction=n,this._modals.deleteTransaction=!0}onDelete(n){return f(this,null,function*(){let e=yield this._incomesService.delete(n.transactionId);if(!e.confirmation){alert(e.message);return}this._modals.deleteTransaction=!1,this.loadTable()})}loadTotalAmount(){let n=this._genericService.convertToCurrencyFormat(this._transactions.reduce((e,t)=>e+t.amount,0));n.confirmation&&this._totalAmountSignal.set(`${this._localStorage.currency} ${n.data}`)}onLoadPartialTable(n){this._partialTableOptions=n}onChangePartialTable(n){this._partialTableOptions=n,this.loadTable()}search(n){this._partialTableOptions.search=n.target.value,this.loadTable()}static \u0275fac=function(e){return new(e||c)};static \u0275cmp=W({type:c,selectors:[["app-incomes"]],features:[U([E,I,w,Z])],decls:14,vars:5,consts:[["caption",""],["header",""],["body",""],["footer",""],[1,"card"],[3,"eventOnLoad","eventOnChange","_values","_options"],["id","container"],[3,"formGroup"],[1,"caption"],["type","button",1,"btn","success",3,"click"],["type","text","placeholder","Busqueda rapida...",3,"input"],[1,"operations"],["type","button","title","Editar",1,"btn","primary",3,"click"],[1,"pi","pi-pen-to-square"],["type","button","title","Eliminar",1,"btn","danger",3,"click"],[1,"pi","pi-trash"],[3,"ngSubmit","formGroup"],[3,"eventCloseModal"],[1,"form"],[1,"form-group"],["for","name"],["type","text","formControlName","name","id","name","name","name","autocomplete","off","required",""],["for","amount"],["_id","amount","_formControlName","amount","_autocomplete","off",3,"_form"],["for","date"],["_formControlName","date","_autocomplete","off",3,"_form"],["for","category"],["formControlName","categoryId","id","category","name","category","required",""],[3,"value"],["for","description"],["formControlName","description","id","description","name","description","autocomplete","off"],[1,"footer"],["type","submit",1,"btn","success",3,"disabled"],[3,"eventOnSuccess","eventOnCancel"]],template:function(e,t){if(e&1){let o=M();r(0,"section")(1,"div",4)(2,"partial-table",5),y("eventOnLoad",function(p){return C(o),b(t.onLoadPartialTable(p))})("eventOnChange",function(p){return C(o),b(t.onChangePartialTable(p))}),P(3,Se,6,0,"ng-template",null,0,x)(5,Me,15,0,"ng-template",null,1,x)(7,Pe,21,13,"ng-template",null,2,x),i(),l(9),i(),r(10,"div",4),v(11,"div",6),i()(),P(12,ke,8,1,"form",7)(13,Fe,5,0,"partial-modalconfirmation")}e&2&&(d(2),S("_values",t._transactions)("_options",t._partialTableOptions),d(7),R(" TOTAL: ",t._totalAmountSignal()," "),d(3),k(t._modals.transaction&&t._form!==null?12:-1),d(),k(t._modals.deleteTransaction&&t._selectedTransaction!==null?13:-1))},dependencies:[J,w,de,ie,le,se,te,ce,ne,oe,me,K,ge,ae,re,_e,ue,Y,fe,Ce],styles:["partial-table[_ngcontent-%COMP%]   .container[_ngcontent-%COMP%]{width:100%;display:grid;gap:10px}partial-table[_ngcontent-%COMP%]   .container[_ngcontent-%COMP%]   .body[_ngcontent-%COMP%]{overflow:auto;max-height:400px}partial-table[_ngcontent-%COMP%]   .container[_ngcontent-%COMP%]   .body[_ngcontent-%COMP%]   table.partial-table[_ngcontent-%COMP%]{background-color:var(--color-black);border:1px solid var(--color-black-border);min-width:100%;border-spacing:0;border-collapse:collapse;position:relative}partial-table[_ngcontent-%COMP%]   .container[_ngcontent-%COMP%]   .body[_ngcontent-%COMP%]   table.partial-table[_ngcontent-%COMP%]   thead[_ngcontent-%COMP%]{background-color:var(--color-black);position:sticky;top:-1px}partial-table[_ngcontent-%COMP%]   .container[_ngcontent-%COMP%]   .body[_ngcontent-%COMP%]   table.partial-table[_ngcontent-%COMP%]   thead[_ngcontent-%COMP%]   tr[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]{padding:10px;text-align:left;word-break:break-word;overflow-wrap:break-word}partial-table[_ngcontent-%COMP%]   .container[_ngcontent-%COMP%]   .body[_ngcontent-%COMP%]   table.partial-table[_ngcontent-%COMP%]   tbody[_ngcontent-%COMP%]   tr[_ngcontent-%COMP%]:nth-child(odd){background-color:var(--color-black-weight)}partial-table[_ngcontent-%COMP%]   .container[_ngcontent-%COMP%]   .body[_ngcontent-%COMP%]   table.partial-table[_ngcontent-%COMP%]   tbody[_ngcontent-%COMP%]   tr[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{padding:10px;text-align:left;word-break:break-word;overflow-wrap:break-word}section[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:20px}section[_ngcontent-%COMP%]   .caption[_ngcontent-%COMP%]{display:grid;grid-template-columns:2fr auto 1fr;align-items:center;gap:10px}section[_ngcontent-%COMP%]   .card[_ngcontent-%COMP%]{display:flex;flex-direction:column;padding:20px;gap:5px;border-radius:10px;background-color:var(--color-black);border:1px solid var(--color-black-border)}section[_ngcontent-%COMP%]   .card[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{font-size:1.6rem}section[_ngcontent-%COMP%]   .card[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]{font-size:1.2rem}section[_ngcontent-%COMP%]   .card[_ngcontent-%COMP%]   span.title[_ngcontent-%COMP%]{font-size:1.3rem}section[_ngcontent-%COMP%]   .card[_ngcontent-%COMP%]   span.comment[_ngcontent-%COMP%]{font-size:.8rem;color:var(--color-black-text)}section[_ngcontent-%COMP%]   .card[_ngcontent-%COMP%]   .operations[_ngcontent-%COMP%]{display:flex;gap:5px;align-items:center;justify-content:center;font-size:1px}section[_ngcontent-%COMP%]   .card[_ngcontent-%COMP%]   .operations[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{padding:5px 10px;font-size:.8rem!important}form[_ngcontent-%COMP%]   .form[_ngcontent-%COMP%], form[_ngcontent-%COMP%]   .form[_ngcontent-%COMP%]   .form-group[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:10px}form[_ngcontent-%COMP%]   .form[_ngcontent-%COMP%]   .form-group[_ngcontent-%COMP%]   label[_ngcontent-%COMP%]{font-size:1.1rem}form[_ngcontent-%COMP%]   .footer[_ngcontent-%COMP%]{display:flex;justify-content:flex-end}"]})};export{be as IncomesComponent};
